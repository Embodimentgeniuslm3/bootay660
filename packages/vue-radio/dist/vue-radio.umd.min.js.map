{"version":3,"file":"vue-radio.umd.min.js","sources":["../src/radio.js","../src/helpers.js","../src/index.js"],"sourcesContent":["const isFunction = arg => typeof arg === 'function';\nconst last = arr => arr[arr.length - 1];\nconst noop = () => { };\nconst replyEvent = id => `reply->${id}`;\nconst requestEvent = id => `request->${id}`;\n\nclass Channel {\n  constructor(bus, id) {\n    this._bus = bus;\n    this._id = id;\n    this._repliers = new Map();\n  }\n\n  eventName = event => this._id ? [this._id, event].join('/') : event;\n\n  emit = delegateBus('$emit')\n  on = delegateBus('$on')\n  once = delegateBus('$once')\n  off = delegateBus('$off')\n\n  request(id, ...args) {\n    const onReply = isFunction(last(args)) ? args.pop() : noop;\n    this.once(replyEvent(id), onReply);\n    this.emit(requestEvent(id), ...args);\n    return this;\n  }\n\n  reply(id, listener) {\n    const callback = (...args) => this.emit(replyEvent(id), ...args);\n    const onRequest = (...args) => listener(...args, callback);\n    this._repliers.set(listener, onRequest);\n    this.on(requestEvent(id), onRequest);\n    return this;\n  }\n\n  replyOnce(id, listener) {\n    const callback = (...args) => this.emit(replyEvent(id), ...args);\n    const onRequest = (...args) => listener(...args, callback);\n    this._repliers.set(listener, onRequest);\n    this.once(requestEvent(id), onRequest);\n    return this;\n  }\n\n  stopReplying(id, listener) {\n    const onRequest = this._repliers.get(listener);\n    if (onRequest) this._repliers.delete(onRequest);\n    this.off(requestEvent(id), onRequest);\n    return this;\n  }\n}\n\nfunction delegateBus(method) {\n  return function (event, ...args) {\n    this._bus[method](this.eventName(event), ...args);\n    return this;\n  };\n}\n\nexport default class Radio {\n  static _instance = null;\n  static _channels = new Map();\n\n  constructor(bus) {\n    this._bus = bus;\n  }\n\n  channel(id) {\n    const { _channels: channels } = this.constructor;\n    if (channels.has(id)) return channels.get(id);\n    const channel = new Channel(this._bus, id);\n    channels.set(id, channel);\n    return channel;\n  }\n\n  static getInstance(vm) {\n    this._instance = this._instance = new Radio(vm.$root);\n    return this._instance;\n  }\n}\n","const isFunction = arg => typeof arg === 'function';\n\nexport function mapChannels(channels) {\n  return mapKeys(castObject(channels), name => {\n    return vm => vm.$radio.channel(name);\n  });\n}\n\nexport function mapRequests(channel, requests) {\n  const getChannel = !isFunction(channel)\n    ? vm => vm.$radio.channel(channel)\n    : channel;\n  return mapKeys(castObject(requests), request => {\n    return function (...args) {\n      return getChannel(this).request(request, ...args);\n    };\n  });\n}\n\nfunction castObject(arg) {\n  if (!Array.isArray(arg)) return arg;\n  return arg.reduce((acc, name) => {\n    return Object.assign(acc, { [name]: name });\n  }, {});\n}\n\nfunction mapKeys(obj, cb) {\n  return Object.entries(obj).reduce((acc, [key, value]) => {\n    value = cb(value, key);\n    return Object.assign(acc, { [key]: value });\n  }, {});\n}\n","import Radio from './radio';\n\nexport const install = Vue => {\n  Object.defineProperty(Vue.prototype, '$radio', {\n    get() {\n      const radio = Radio.getInstance(this);\n      return {\n        channel: id => wrapChannel(radio.channel(id), this),\n        emit: delegateChannel('emit'),\n        on: delegateChannel('on'),\n        once: delegateChannel('once'),\n        off: delegateChannel('off'),\n        request: delegateChannel('request'),\n        reply: delegateChannel('reply'),\n        replyOnce: delegateChannel('replyOnce'),\n        stopReplying: delegateChannel('stopReplying')\n      };\n\n      function delegateChannel(method) {\n        return (channelId, ...args) => {\n          const channel = this.channel(channelId);\n          channel[method](...args);\n          return this;\n        };\n      }\n    }\n  });\n};\n\nexport * from './helpers';\nexport default install;\n\nfunction wrapChannel(channel, vm) {\n  const cleanup = new (class extends Map {\n    constructor(vm) {\n      super();\n      this._vm = vm;\n    }\n\n    set(listener, disposeFn) {\n      if (!this.size) this._vm.$once('hook:beforeDestroy', this.run);\n      super.set(listener, disposeFn);\n      return this;\n    }\n\n    delete(listener) {\n      super.delete(listener);\n      if (!this.size) this._vm.$off('hook:beforeDestroy', this.run);\n      return this;\n    }\n\n    run = () => this.forEach(disposeFn => disposeFn());\n  })(vm);\n\n  return {\n    // Proxy method invocations.\n    emit: channel.emit.bind(channel),\n    request: channel.request.bind(channel),\n    // Autoclean listener registrations.\n    on(event, listener) {\n      cleanup.set(listener, () => channel.off(event, listener));\n      return channel.on(event, listener);\n    },\n    once(event, listener) {\n      cleanup.set(listener, () => channel.off(event, listener));\n      return channel.once(event, listener);\n    },\n    reply(id, listener) {\n      cleanup.set(listener, () => channel.stopReplying(id, listener));\n      return channel.reply(id, listener);\n    },\n    replyOnce(id, listener) {\n      cleanup.set(listener, () => channel.stopReplying(id, listener));\n      return channel.replyOnce(id, listener);\n    },\n    off(event, listener) {\n      cleanup.delete(listener);\n      return channel.off(event, listener);\n    },\n    stopReplying(id, listener) {\n      cleanup.delete(listener);\n      return channel.stopReplying(id, listener);\n    }\n  };\n}\n"],"names":["isFunction","arg","last","arr","length","noop","replyEvent","id","requestEvent","Channel","bus","event","_this","_id","join","delegateBus","_bus","_repliers","Map","args","onReply","pop","once","emit","this","listener","callback","_this2","onRequest","set","on","_this3","get","delete","off","method","eventName","Radio","channels","constructor","_channels","has","channel","vm","_instance","$root","castObject","Array","isArray","reduce","acc","name","Object","assign","mapKeys","obj","cb","entries","key","value","install","Vue","defineProperty","prototype","radio","getInstance","cleanup","forEach","disposeFn","_vm","size","$once","run","$off","bind","request","reply","stopReplying","replyOnce","wrapChannel","delegateChannel","channelId","$radio","requests","getChannel"],"mappings":"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"}